+++
author = "Антон Корепанов"
categories = ["Lectures"]
date = 2015-08-19T00:00:00Z
description = ""
draft = false
slug = "releases-every-day"
tags = ["Programming","Lectures"]
title = "DevOps: Релизы каждый день"

+++


[![365x365](http://res.cloudinary.com/ampersd/image/upload/v1467022680/365x365_rw0ycb.jpg)](http://res.cloudinary.com/ampersd/image/upload/v1467022680/365x365_rw0ycb.jpg)

**Это конспект события**: Релизы каждый день  
**Дата**: 18 августа 2015  
**Место**: Digital Port, Пермь  
**Спикер**: Михаил Трошев, руководитель службы поисковых интерфейсов Яндекса (визитка [http://mishanga.pro/](http://mishanga.pro/), описание [https://events.yandex.ru/lib/people/392/](https://events.yandex.ru/lib/people/392/))  
**Полезность (лично для меня)**: 6/10

**О спикере**: Михаил живет в Москве 10 лет. Поначалу работал в студии Артемия Лебедева. 3 года назад перешел в Яндекс. Он и его команда ответственны за внешний вид страницы поисковой выдачи. Т.е. за святая святых.


## 3 года назад

- Поначалу фронтенд релизился bash-скриптами, которые писали перлщики
- **Релиз раз в четыре месяца (настолько долгим был процесс)**
- SVN (централизованная система контроля версий)

**Что хотели:**

- Быстро реагировать на события
- Быстро выкладывать клевые фичи
- Проводить много экспериментов (выкатывать сырой дизайн, улучшать потом)
- Делать фичи, а не чинить баги

**Размышления:**

- SVN — это плохо
- Ручная подготовка беты для тестирования
- Никаких модульных тестов
- Медленное тестирование: - Ручное тестирование
- Ожидание беты для тестирования
- Ожидание разработчика
- Плохое описание задач
- Тестирование в режиме пиковых нагрузок

Команда тестирования поиска Яндекса сидит в Минске, что несколько затрудняет коммуникацию.

Медленная подготовка релиза:

- Много ручных действий
- Человеческий фактор
- Сакральные знания, [автобусное число](https://www.wikiwand.com/ru/%D0%A4%D0%B0%D0%BA%D1%82%D0%BE%D1%80_%D0%B0%D0%B2%D1%82%D0%BE%D0%B1%D1%83%D1%81%D0%B0) (сколько разработчиков должен сбить автобус, чтобы проект стало невозможно релизить). В случае с командой того времени, это число равнялось одному, т.к. один человек собирал релизы вручную.


## Тернистый путь к улучшениям

- Git — распределенная система контроля версий
- Gitflow — рекомендуемый workflow git’a, слегка модифицировали его
- Инстанс github enterprise для яндекса (можно код ревью осуществлять)

Gitflow* (отличие от стандартного):

- Прямых коммитов в dev не делают, только merge
- Поэтому можно, если фича плохая — сразу ее отцепить
- Вообще отказались от master ветки

Для CI используют teamcity  
 При pull request’e сначала код проверяют другие разработчики, затем запускаются различные легковесные узконаправленные тесты (не все возможные, а только те, которые касаются конкретных измененных файлов), также используют [Gemini](https://ru.bem.info/tools/testing/gemini/) — open-source инструмент сравнения с идеальным скриншотом.

**Релиз стал сходиться 2 недели**  
 Почему так медленно?  
 Очень долго шло [регрессионное тестирование](https://www.wikiwand.com/ru/%D0%A0%D0%B5%D0%B3%D1%80%D0%B5%D1%81%D1%81%D0%B8%D0%BE%D0%BD%D0%BD%D0%BE%D0%B5_%D1%82%D0%B5%D1%81%D1%82%D0%B8%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5)

**Ввели правило**:

Если нашли баг, и до вечера его не исправили — отрывают мердж полностью — делают реверт-коммит (т.е. Который отменяет все изменения)  
 Если дежурный не смог оторвать этот мердж, это делает сам разработчик.

**Не надо чинить в авральном режиме, надо делать это спокойно**

**Самое главное правило**  
 Релизные задачи имеют наивысший приоритет

Т.е. если разработчик занимается какой-то новой фичей, а ему прилетает баг по старой, которая нужна для релиза — он откладывает новую фичу в сторону и берется чинить баг.


## Автоматизация релиза

**Попытка 1.** Использовать hubot (робота github’a)  — не удовлетворял требованиям.  
**Попытка 2.** Хотели поначалу склепать свою систему с кодовым именем Hodor

- прототип интерфейса
- требования по автоматизации
- скрипты

Вердикт: Слишком сложно  
 Ничего кроме скриптов на самом деле не нужно

Тем более что у них уже был teamcity

Решили проанализировать какие элементарные шаги проводит релиз-инженер и автоматизировать каждый отдельный шаг через скрипт.

**Действия релиз-инженера:**

- Отвести ветку с релизом
- Добавить задачу а релиз
- Оторвать задачу из релиза
- Собрать релиза пакеты
- Отправить в текстовый кластер
- Отправить в боевой кластер

Отрывание задачи из релиза решили не автоматизировать  
 Слишком трудозатратна автоматизация

На остальные действия — свои скрипты по-каждому.


## Выводы

- Делим релиз на атомарные действия
- Делаем на каждое действие скрипт
- Не пляшем от интерфейса или готовой системы. Т.е. не от человека, а от процесса. Не начинать рисовать кнопочки веб-приложения, а просто сделать сами скрипты.

Эти скрипты крутятся в teamcity, но даже если она сломается, можно руками запустить эти шаги последовательно — отказоустойчивость системы.


